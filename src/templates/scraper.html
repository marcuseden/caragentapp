{% extends "base.html" %}

{% block title %}Car Scraper | CarAgentApp{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-6">Car Scraper</h1>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <!-- Scraper Stats Card -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">Scraper Statistics</h2>
            <div id="scraperStats" class="space-y-2">
                <div class="flex justify-between">
                    <span>Total Cars:</span>
                    <span id="totalCars" class="font-bold">Loading...</span>
                </div>
                <div class="flex justify-between">
                    <span>Cars with Source URLs:</span>
                    <span id="carsWithUrl" class="font-bold">Loading...</span>
                </div>
                <div class="flex justify-between">
                    <span>Cars without Source URLs:</span>
                    <span id="carsWithoutUrl" class="font-bold">Loading...</span>
                </div>
            </div>
        </div>
        
        <!-- Run Scraper Card -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">Run Scraper</h2>
            <form id="scraper-form" class="space-y-4">
                <div>
                    <label for="scraper-type" class="block text-sm font-medium text-gray-700">Scraper Type</label>
                    <select id="scraper-type" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                        <option value="simple">Simple Scraper</option>
                        <option value="large">Large Scale Scraper</option>
                        <option value="real">Real Scraper</option>
                        <option value="default">Default Scraper</option>
                    </select>
                </div>
                
                <div>
                    <label for="scraper-country" class="block text-sm font-medium text-gray-700">Country</label>
                    <select id="scraper-country" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                        <option value="denmark">Denmark</option>
                        <option value="sweden">Sweden</option>
                        <option value="norway">Norway</option>
                        <option value="germany">Germany</option>
                        <option value="portugal">Portugal</option>
                        <option value="poland">Poland</option>
                        <option value="france">France</option>
                        <option value="italy">Italy</option>
                    </select>
                </div>
                
                <div>
                    <button type="submit" id="run-scraper-btn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Run Scraper
                    </button>
                </div>
            </form>
            
            <div id="scraper-status" class="mt-4 p-4 rounded-lg bg-gray-50 hidden">
                <p id="scraper-status-message" class="text-sm"></p>
            </div>
        </div>
    </div>
    
    <!-- Custom Scraper Card -->
    <div class="bg-white p-6 rounded-lg shadow-md mb-8">
        <h2 class="text-xl font-semibold mb-4">Custom Scraper</h2>
        
        <form id="custom-scraper-form" class="space-y-4">
            <div>
                <label for="listing-urls" class="block text-sm font-medium text-gray-700">Listing URLs (one per line)</label>
                <textarea id="listing-urls" rows="5" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
            </div>
            
            <div>
                <label for="max-cars" class="block text-sm font-medium text-gray-700">Maximum Cars to Scrape</label>
                <input type="number" id="max-cars" value="100" min="1" max="1000" 
                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            </div>
            
            <div>
                <button type="submit" id="custom-scraper-btn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Start Custom Scraper
                </button>
            </div>
        </form>
        
        <div id="custom-scraper-status" class="mt-4 p-4 rounded-lg bg-gray-50 hidden">
            <p id="custom-scraper-status-message" class="text-sm"></p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', async function() {
        // Get elements
        const scraperForm = document.getElementById('scraper-form');
        const scraperType = document.getElementById('scraper-type');
        const scraperCountry = document.getElementById('scraper-country');
        const runScraperBtn = document.getElementById('run-scraper-btn');
        const scraperStatus = document.getElementById('scraper-status');
        const scraperStatusMessage = document.getElementById('scraper-status-message');
        
        const customScraperForm = document.getElementById('custom-scraper-form');
        const listingUrls = document.getElementById('listing-urls');
        const maxCars = document.getElementById('max-cars');
        const customScraperBtn = document.getElementById('custom-scraper-btn');
        const customScraperStatus = document.getElementById('custom-scraper-status');
        const customScraperStatusMessage = document.getElementById('custom-scraper-status-message');
        
        // Load stats
        async function loadStats() {
            try {
                const response = await fetch('/api/admin/stats');
                const data = await response.json();
                
                document.getElementById('totalCars').textContent = data.total_cars.toLocaleString();
                document.getElementById('carsWithUrl').textContent = data.cars_with_url.toLocaleString();
                document.getElementById('carsWithoutUrl').textContent = data.cars_without_url.toLocaleString();
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }
        
        // Load stats on page load
        loadStats();
        
        // Handle scraper form submission
        scraperForm.addEventListener('submit', function(event) {
            event.preventDefault();
            
            // Disable the button to prevent multiple submissions
            runScraperBtn.disabled = true;
            runScraperBtn.innerHTML = '<svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Running...';
            
            // Get the selected values
            const type = scraperType.value;
            const country = scraperCountry.value;
            
            // Call the API to run the scraper
            fetch('/api/admin/run-scraper', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    type: type,
                    country: country
                }),
            })
            .then(response => response.json())
            .then(data => {
                // Show the status message
                scraperStatus.classList.remove('hidden');
                scraperStatus.classList.add('bg-blue-50');
                scraperStatusMessage.textContent = data.message;
                
                // Re-enable the button after a delay
                setTimeout(() => {
                    runScraperBtn.disabled = false;
                    runScraperBtn.innerHTML = 'Run Scraper';
                    
                    // Update stats after a delay to reflect new data
                    setTimeout(loadStats, 5000);
                }, 3000);
            })
            .catch(error => {
                console.error('Error:', error);
                scraperStatus.classList.remove('hidden');
                scraperStatus.classList.add('bg-red-50');
                scraperStatusMessage.textContent = 'Error starting scraper: ' + error;
                runScraperBtn.disabled = false;
                runScraperBtn.innerHTML = 'Run Scraper';
            });
        });
        
        // Handle custom scraper form submission
        customScraperForm.addEventListener('submit', function(event) {
            event.preventDefault();
            
            // Validate inputs
            const urlsText = listingUrls.value.trim();
            if (!urlsText) {
                customScraperStatus.classList.remove('hidden');
                customScraperStatus.classList.add('bg-red-50');
                customScraperStatusMessage.textContent = 'Please enter at least one URL';
                return;
            }
            
            // Parse URLs (one per line)
            const urls = urlsText.split('\n')
                .map(url => url.trim())
                .filter(url => url.length > 0);
            
            if (urls.length === 0) {
                customScraperStatus.classList.remove('hidden');
                customScraperStatus.classList.add('bg-red-50');
                customScraperStatusMessage.textContent = 'Please enter at least one valid URL';
                return;
            }
            
            // Get max cars
            const maxCarsValue = parseInt(maxCars.value);
            if (isNaN(maxCarsValue) || maxCarsValue < 1) {
                customScraperStatus.classList.remove('hidden');
                customScraperStatus.classList.add('bg-red-50');
                customScraperStatusMessage.textContent = 'Please enter a valid number for maximum cars';
                return;
            }
            
            // Disable the button to prevent multiple submissions
            customScraperBtn.disabled = true;
            customScraperBtn.innerHTML = '<svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Scraping...';
            
            // Call the API to run the custom scraper
            fetch('/api/admin/scrape-cars', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    urls: urls,
                    max_cars: maxCarsValue
                }),
            })
            .then(response => response.json())
            .then(data => {
                // Show the status message
                customScraperStatus.classList.remove('hidden');
                customScraperStatus.classList.add('bg-blue-50');
                customScraperStatusMessage.textContent = data.message;
                
                // Re-enable the button after a delay
                setTimeout(() => {
                    customScraperBtn.disabled = false;
                    customScraperBtn.innerHTML = 'Start Custom Scraper';
                    
                    // Update stats after a delay to reflect new data
                    setTimeout(loadStats, 5000);
                }, 3000);
            })
            .catch(error => {
                console.error('Error:', error);
                customScraperStatus.classList.remove('hidden');
                customScraperStatus.classList.add('bg-red-50');
                customScraperStatusMessage.textContent = 'Error starting custom scraper: ' + error;
                customScraperBtn.disabled = false;
                customScraperBtn.innerHTML = 'Start Custom Scraper';
            });
        });
    });
</script>
{% endblock %} 